name: Database Maintenance

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Database operation to perform'
        required: true
        default: 'backup'
        type: choice
        options:
        - backup
        - migrate
        - cleanup
        - validate
      environment:
        description: 'Environment to operate on'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT_ID: stage-pass-b1d9b

jobs:
  database-operations:
    name: Database ${{ github.event.inputs.operation }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Setup Firebase
      run: |
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" > service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=service-account.json
        
    - name: Database Backup
      if: ${{ github.event.inputs.operation == 'backup' }}
      run: |
        echo "🔄 Creating database backup..."
        firebase firestore:export gs://stage-pass-b1d9b-backups/backup-$(date +%Y%m%d-%H%M%S) --project ${{ env.FIREBASE_PROJECT_ID }}
        echo "✅ Backup completed"
        
    - name: Database Migration
      if: ${{ github.event.inputs.operation == 'migrate' }}
      run: |
        echo "🔄 Running database migration..."
        # Add your migration scripts here
        node scripts/migrate.js || echo "No migration script found"
        echo "✅ Migration completed"
        
    - name: Database Cleanup
      if: ${{ github.event.inputs.operation == 'cleanup' }}
      run: |
        echo "🧹 Running database cleanup..."
        # Add cleanup scripts here
        node scripts/cleanup.js || echo "No cleanup script found"
        echo "✅ Cleanup completed"
        
    - name: Database Validation
      if: ${{ github.event.inputs.operation == 'validate' }}
      run: |
        echo "🔍 Validating database structure..."
        # Add validation scripts here
        node scripts/validate.js || echo "No validation script found"
        echo "✅ Validation completed"
        
    - name: Cleanup
      if: always()
      run: |
        rm -f service-account.json
